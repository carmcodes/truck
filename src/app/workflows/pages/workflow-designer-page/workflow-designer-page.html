<div style="display:flex; flex-direction:column; gap:12px; padding:14px;">
    <div
            style="
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border:1px solid #e6e6e6;
      border-radius:12px;
      background:#fff;
    "
    >
        <div style="min-width:0;">
            <div style="display:flex; align-items:center; gap:10px; min-width:0;">
                <h2 style="margin:0; font-size:18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                    {{ facade.workflow()?.name || 'Untitled workflow' }}
                </h2>

                <span
                        style="
            font-size:12px;
            padding:2px 8px;
            border-radius:999px;
            border:1px solid #e6e6e6;
            background:#fafafa;
            flex:0 0 auto;
          "
                >
          v{{ facade.workflow()?.version ?? 0 }}
        </span>
            </div>
        </div>

        <div style="display:flex; gap:8px; align-items:center; flex:0 0 auto;">
            <ds-button (click)="back()">Back</ds-button>

            <ds-button
                    (click)="saveWorkflow()"
                    [disabled]="facade.saving()"
                    style="font-weight:600;"
            >
                {{ facade.saving() ? 'Saving…' : 'Save' }}
            </ds-button>

            <select
                    style="padding:6px 10px; border-radius:10px; border:1px solid #e6e6e6; background:#fff;"
                    [disabled]="facade.running()"
                    [value]="runExtension()"
                    (change)="runExtension.set($any($event.target).value)"
                    title="Export type"
            >
                @if ((facade.exportTypes()?.length ?? 0) === 0) {
                    <option value=".json">.json</option>
                } @else {
                    @for (t of facade.exportTypes(); track t.extension) {
                        <option [value]="t.extension">{{ t.name }} ({{ t.extension }})</option>
                    }
                }
            </select>

            <ds-button
                    (click)="run()"
                    [disabled]="facade.running() || !canRun()"
                    style="font-weight:700;"
                    [title]="getRunButtonTitle()"
            >
                {{ facade.running() ? 'Running…' : 'Run' }}
            </ds-button>
        </div>
    </div>

    @if (facade.error()) {
        <div
                style="
        border:1px solid #ffd1d1;
        background:#fff5f5;
        color:#b00020;
        padding:10px 12px;
        border-radius:10px;
      "
        >
            {{ facade.error() }}
        </div>
    }

    <div style="display:grid; grid-template-columns: 280px 1fr 360px; gap:12px; height: calc(100vh - 190px);">

        <div style="min-width:0;">
            <app-steps-sidebar
                    [steps]="facade.steps()"
                    [selectedStepId]="facade.selectedStepId()"
                    (selectStep)="onStepSelected($event)"
                    (addStep)="facade.addStep('')"
                    (deleteLastStep)="facade.deleteLastStep()"
            />
        </div>

        <div style="display:flex; flex-direction:column; gap:12px; min-width:0;">

            <div
                    style="
          border:1px solid #e6e6e6;
          border-radius:12px;
          background:#fff;
          padding:12px;
        "
            >
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div style="font-weight:900;">Workflow Details</div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr; gap:10px;">
                    <div>
                        <ds-form-field>
                            <label ds-label style="font-size:12px; font-weight:800;">Name</label>
                            <input ds-input
                                   style="width:100%;"
                                   [value]="facade.workflow()?.name ?? ''"
                                   (input)="facade.patchWorkflow({ name: $any($event.target).value })"
                            />
                        </ds-form-field>
                    </div>

                    <div>
                        <ds-form-field>
                            <label ds-label style="font-size:12px; font-weight:800;">Description</label>
                            <textarea ds-input
                                      style="width:100%; height:80px; resize:vertical;"
                                      [value]="facade.workflow()?.description ?? ''"
                                      (input)="facade.patchWorkflow({ description: $any($event.target).value })"
                            ></textarea>
                        </ds-form-field>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div style="border:1px solid #eee; border-radius:12px; padding:10px; background:#fafafa;">
                            <div style="font-size:12px; font-weight:900;">Created</div>
                            <div style="font-size:12px; opacity:.75; margin-top:4px;">
                                {{ facade.workflow()?.createdAt ? (facade.workflow()?.createdAt | date:'medium') : '—' }}
                            </div>
                        </div>
                        <div style="border:1px solid #eee; border-radius:12px; padding:10px; background:#fafafa;">
                            <div style="font-size:12px; font-weight:900;">Last updated</div>
                            <div style="font-size:12px; opacity:.75; margin-top:4px;">
                                {{ facade.workflow()?.updatedAt ? (facade.workflow()?.updatedAt | date:'medium') : '—' }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <app-step-config-panel
                    [steps]="facade.steps()"
                    [step]="facade.selectedStep()"
                    (patchStep)="facade.patchStep($event.stepId, $event.patch)"
            />

            <div
                    style="
          flex:1;
          min-height:0;
          border:1px solid #e6e6e6;
          border-radius:12px;
          background:#fff;
          overflow:hidden;
          display:flex;
          flex-direction:column;
        "
            >
                <div
                        style="
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:10px;
            padding:10px 12px;
            border-bottom:1px solid #eee;
            background:#fafafa;
          "
                >
                    <div style="min-width:0;">
                        <div style="font-weight:900;">Script</div>
                        <div style="font-size:12px; opacity:.7;">
                            @if (facade.selectedStep()) {
                                Editing: {{ facade.selectedStep()?.name }} • Alias:
                                <code>{{ facade.selectedStep()?.alias }}</code>
                            } @else {
                                Select a step to edit its script.
                            }
                        </div>
                    </div>

                    <div style="display:flex; gap:8px; align-items:center;">
                        @if (!isScriptSaved())
                        {
                        <ds-button
                                (click)="saveScript()"
                                [disabled]="facade.saving() || !facade.selectedStep() || hasScriptErrors()"
                                [title]="hasScriptErrors() ? 'Fix syntax errors before saving' : 'Uploads script + selected outputs'"
                                style="font-weight:800;"
                        >
                            Save Script
                        </ds-button>
                        }
                    </div>
                </div>

                <div style="flex:1; min-height:0;">
                    <app-monaco-step-editor
                            [code]="facade.selectedStep() ? facade.getStepScript(facade.selectedStep()!.id) : ''"
                            [availableVariables]="facade.availableVariablesForSelectedStep()"
                            [readOnly]="isScriptSaved()"
                            (codeChange)="onCodeChange($event)"
                            (syntaxErrorsChange)="facade.selectedStep() && facade.setStepSyntaxErrors(facade.selectedStep()!.id, $event)"
                    ></app-monaco-step-editor>
                </div>
            </div>

        </div>

        <div style="display:flex; flex-direction:column; gap:12px; min-width:0;">

            <app-inputs-panel
                    [stepId]="facade.selectedStep()?.id ?? null"
                    [stepIndex]="facade.selectedStep() ? facade.getStepDisplayIndex(facade.selectedStep()!.id) : null"
                    [stepAlias]="facade.selectedStep()?.alias ?? null"
                    [stepInputs]="facade.selectedStep() ? facade.getStepInputs(facade.selectedStep()!.id) : {}"
                    (uploadInput)="facade.uploadSelectedStepInput($event)"
                    (clearInputs)="facade.selectedStep() && facade.clearStepInputs(facade.selectedStep()!.id)"
            ></app-inputs-panel>

            <app-variables-panel
                    [step]="facade.selectedStep()"
                    [availableVariables]="facade.availableVariablesForSelectedStep()"
                    [includedOutputs]="facade.selectedStep() ? facade.getIncludedOutputs(facade.selectedStep()!.id) : []"
                    (includedOutputsChange)="facade.setIncludedOutputs($event.stepId, $event.includedOutputs)"
            ></app-variables-panel>

        </div>
    </div>
</div>