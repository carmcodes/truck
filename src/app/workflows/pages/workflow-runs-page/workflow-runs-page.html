<div style="display:flex; flex-direction:column; gap:12px; padding:14px;">

  <!-- Top bar (no IDs) -->
  <div
    style="
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:12px 14px; border:1px solid #e6e6e6; border-radius:12px; background:#fff;
    "
  >
    <div style="min-width:0;">
      <div style="font-weight:900; font-size:16px;">Runs</div>
      <div style="font-size:12px; opacity:.7; margin-top:2px;">
        Review the checked variables (selected outputs) + logs per step.
      </div>
    </div>

    <div style="display:flex; gap:8px; align-items:center;">
      <ds-button (click)="backToDesigner()">Back to designer</ds-button>
      <ds-button (click)="refresh()">Refresh</ds-button>
      <ds-button (click)="clearHistory()" title="Clear stored run history">Clear history</ds-button>
    </div>
  </div>

  <!-- Layout -->
  <div style="display:grid; grid-template-columns: 320px 1fr; gap:12px; height: calc(100vh - 170px);">

    <!-- Runs list -->
    <div style="border:1px solid #e6e6e6; border-radius:12px; background:#fff; overflow:auto;">
      <div style="padding:10px 12px; border-bottom:1px solid #eee; font-weight:900;">
        History
      </div>

      @if (runs().length === 0) {
        <div style="padding:12px; opacity:.7;">No runs yet.</div>
      } @else {
        <div style="padding:10px;">
          @for (r of runs(); track r.runId; let i = $index) {
            <div
              (click)="selectRun(r.runId)"
              [style.border]="selectedRunId() === r.runId ? '1px solid #222' : '1px solid #eee'"
              style="
                padding:10px; border-radius:12px; cursor:pointer; margin-bottom:8px;
                background:#fafafa;
              "
            >
              <div style="display:flex; justify-content:space-between; gap:8px; align-items:center;">
                <div style="font-weight:800;">Run {{ runs().length - i }}</div>
                <div style="font-size:12px; opacity:.7;">{{ r.createdAt | date:'short' }}</div>
              </div>

              <div style="font-size:12px; opacity:.7; margin-top:4px;">
                Export: {{ r.extension || '—' }} • Steps: {{ r.result?.stepRuns?.length ?? 0 }}
              </div>
            </div>
          }
        </div>
      }
    </div>

    <!-- Run details -->
    <div style="border:1px solid #e6e6e6; border-radius:12px; background:#fff; overflow:auto;">
      <div style="padding:10px 12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:900;">Details</div>
        @if (selectedRun()) {
          <div style="font-size:12px; opacity:.7;">
            {{ selectedRun()!.createdAt | date:'medium' }}
          </div>
        }
      </div>

      @if (!selectedRun()) {
        <div style="padding:12px; opacity:.7;">Select a run from the left.</div>
      } @else {

        <div style="padding:12px;">
          @if ((selectedRun()!.result?.stepRuns?.length ?? 0) === 0) {
            <div style="opacity:.7;">No steps in this run.</div>
          } @else {

            @for (s of selectedRun()!.result.stepRuns; track s.stepId; let idx = $index) {

              <div
                style="border:1px solid #eee; border-radius:14px; padding:12px; margin-bottom:10px; background:#fff;"
              >
                <!-- Step header -->
                <div
                  (click)="toggleStepByIndex(idx)"
                  style="display:flex; justify-content:space-between; align-items:center; gap:10px; cursor:pointer;"
                >
                  <div style="display:flex; flex-direction:column; gap:4px; min-width:0;">
                    <div style="font-weight:900;">
                      {{ stepTitle(s, idx) }}
                    </div>
                    <div style="font-size:12px; opacity:.7;">
                      {{ statusText(s) }} • {{ s.cached ? 'Cached' : 'Fresh' }}
                    </div>
                  </div>

                  <div style="font-size:12px; opacity:.7;">
                    @if (expandedStepIndex() === idx) { ▲ } @else { ▼ }
                  </div>
                </div>

                <!-- Expanded -->
                @if (expandedStepIndex() === idx) {
                  <div style="margin-top:12px; display:grid; grid-template-columns: 1fr; gap:12px;">

                    <!-- Checked variables only -->
                    <div style="border:1px solid #eee; border-radius:12px; overflow:hidden;">
                      <div style="padding:10px 12px; border-bottom:1px solid #eee; font-weight:900; background:#fafafa;">
                        Selected outputs
                        <div style="font-size:12px; font-weight:400; opacity:.7; margin-top:2px;">
                          Only variables you checked in the Variables panel for this step.
                        </div>
                      </div>

                      @let rows = getSelectedVarsForDisplay(selectedRun()!, s, $index);

                      @if (rows.length === 0) {
                        <div style="opacity:.7;">No selected variables.</div>
                      } @else {
                        <table style="width:100%; border-collapse:collapse; font-size:12px;">
                          <thead>
                          <tr>
                            <th style="text-align:left; padding:8px 10px; border-bottom:1px solid #eee;">Variable</th>
                            <th style="text-align:left; padding:8px 10px; border-bottom:1px solid #eee;">Value</th>
                          </tr>
                          </thead>
                          <tbody>
                            @for (r of rows; track r.key) {
                              <tr>
                                <td style="padding:8px 10px; border-bottom:1px solid #f2f2f2;"><code>{{ r.key }}</code></td>
                                <td style="padding:8px 10px; border-bottom:1px solid #f2f2f2;">
                                  @if (r.found) {
                                    {{ formatValue(r.value) }}
                                  } @else {
                                    <span style="opacity:.6;">(not found)</span>
                                  }
                                </td>
                              </tr>
                            }
                          </tbody>
                        </table>
                      }

                    </div>

                    <!-- Logs -->
                    <div style="border-radius:12px; overflow:hidden; border:1px solid #111;">
                      <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 12px; background:#0b0f14; color:#e6edf3;">
                        <div style="font-weight:900;">Logs</div>
                        <button
                          style="font-size:12px;"
                          (click)="$event.stopPropagation(); copyLogs(s.logs)"
                        >
                          Copy
                        </button>
                      </div>

                      @let lines = logLines(s.logs);

                      <div style="background:#0b0f14; color:#e6edf3; padding:10px;">
                        @if (lines.length === 0) {
                          <div style="opacity:.7;">No logs.</div>
                        } @else {
                          <div style="max-height:280px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace; font-size:12px; line-height:1.45;">
                            @for (ln of lines; track $index) {
                              <div style="display:flex; gap:12px;">
                                <div style="width:36px; text-align:right; opacity:.45;">{{ $index + 1 }}</div>
                                <div style="white-space:pre-wrap; word-break:break-word; flex:1;">{{ ln }}</div>
                              </div>
                            }
                          </div>
                        }
                      </div>
                    </div>

                  </div>
                }
              </div>
            }
          }
        </div>

      }
    </div>
  </div>
</div>
